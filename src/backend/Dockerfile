# –ò—Å–ø–æ–ª—å–∑—É–µ–º SDK –æ–±—Ä–∞–∑ –¥–ª—è —Å–±–æ—Ä–∫–∏
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å csproj —Ñ–∞–π–ª—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY ["MdAPI/Web/Web.csproj", "Web/"]
COPY ["MdAPI/MdPWASM/MdPWASM.csproj", "MdPWASM/"]
RUN dotnet restore "Web/Web.csproj"

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# üõ† –°–±–æ—Ä–∫–∞ WASM –≤ wwwroot
WORKDIR /src/MdAPI/MdPWASM
RUN dotnet publish -c Release -o /src/MdAPI/Web/wwwroot

# üõ† –°–±–æ—Ä–∫–∞ API
WORKDIR /src/MdAPI/Web
RUN dotnet publish -c Release -o /app/publish

# –ò—Å–ø–æ–ª—å–∑—É–µ–º `aspnet` runtime –æ–±—Ä–∞–∑
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS final
WORKDIR /app
COPY --from=build /app/publish .

# –£–∫–∞–∑—ã–≤–∞–µ–º, –Ω–∞ –∫–∞–∫–æ–º –ø–æ—Ä—Ç—É –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–µ—Ä–≤–µ—Ä –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
ENV ASPNETCORE_URLS=http://0.0.0.0:5199

EXPOSE 5199
ENTRYPOINT ["dotnet", "Web.dll"]